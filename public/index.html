<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <title>Qu·∫£n l√Ω CLB Pickleball</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0fdfa',
              100: '#ccfbf1',
              200: '#99f6e4',
              300: '#5eead4',
              400: '#2dd4bf',
              500: '#14b8a6',
              600: '#0d9488',
              700: '#0f766e',
              800: '#115e59',
              900: '#134e4a',
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          }
        }
      }
    }
  </script>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    /* Tailwind Custom Styles */
    .nav-tab {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
      transition: all 0.2s ease;
      white-space: nowrap;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: 14px;
    }

    .nav-tab:hover {
      color: white;
      background-color: rgba(255, 255, 255, 0.1);
    }

    .nav-tab.active {
      background-color: white;
      color: #0f766e;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      font-weight: 600;
    }

    /* Hide scrollbar but keep functionality */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }

    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Fallback for old :root variables */
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --brand: #10b981;
      --brand-hover: #059669;
      --danger: #ef4444;
      --danger-hover: #dc2626;
      --border: #334155;
      --panel: #0b1220;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 20px 50px rgba(0, 0, 0, 0.5);
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
        "Helvetica Neue", Arial;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(71, 85, 105, 0.8);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(20, 184, 166, 0.6);
    }

    /* Selection color */
    ::selection {
      background: rgba(20, 184, 166, 0.3);
      color: white;
    }

    a {
      color: var(--brand);
      text-decoration: none;
      transition: var(--transition);
    }

    a:hover {
      color: var(--brand-hover);
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      gap: 8px;
    }

    li button {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 14px;
      font-weight: 500;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      min-height: 44px;
    }

    li button:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
    }

    li button.active {
      background: var(--card);
      color: var(--brand);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, #0f172a, #0f172aee);
      backdrop-filter: saturate(130%) blur(10px);
      position: sticky;
      top: 0;
      z-index: 20;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .topbar h1 {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--brand), #34d399);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .topbar nav {
      flex-grow: 1;
    }

    .topbar nav ul {
      flex-wrap: wrap;
    }

    /* OLD LAYOUT CSS - Commented out for Tailwind redesign
    .container {
      display: grid;
      grid-template-columns: 1fr 8px 360px;
      min-height: calc(100dvh - 68px);
    }

    .left {
      overflow: auto;
      padding: 24px;
    }

    .handle {
      cursor: col-resize;
      position: relative;
      background: transparent;
      transition: var(--transition);
    }

    .handle:after {
      content: "";
      position: absolute;
      inset: 0;
      transform: translateX(-1px);
      width: 3px;
      background: #ffffff12;
      transition: var(--transition);
    }

    .handle:hover:after {
      background: var(--brand);
      box-shadow: 0 0 8px var(--brand);
    }

    .right {
      border-left: 1px solid var(--border);
      background: var(--panel);
      overflow: auto;
      padding: 20px;
    }
    */

    /* Modern Card Styles */
    .card {
      background: rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(71, 85, 105, 0.5);
      border-radius: 1rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
      margin-bottom: 1.5rem;
      padding: 1.5rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border-color: rgba(20, 184, 166, 0.5);
      transform: translateY(-2px);
    }

    .card h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      letter-spacing: -0.025em;
    }

    .card h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.25rem;
      font-weight: 600;
      color: white;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 20px;
    }

    /* Modern Input & Select Styles */
    .toolbar input,
    .toolbar select {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.6);
      color: white;
      padding: 0.625rem 1rem;
      border-radius: 0.5rem;
      outline: none;
      transition: all 0.2s ease;
      min-height: 44px;
    }

    .toolbar input:focus,
    .toolbar select:focus {
      border-color: #14b8a6;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.15);
      background: rgba(15, 23, 42, 1);
    }

    .toolbar input::placeholder {
      color: rgb(148, 163, 184);
    }

    /* Modern Button Styles */
    .btn {
      padding: 0.625rem 1rem;
      border-radius: 0.5rem;
      border: none;
      background: rgb(51, 65, 85);
      color: white;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.875rem;
      line-height: 1.5;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      background: rgb(71, 85, 105);
    }

    .btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .btn.primary {
      background: linear-gradient(135deg, #14b8a6 0%, #10b981 100%);
      border-color: transparent;
      box-shadow: 0 4px 6px -1px rgba(20, 184, 166, 0.3);
    }

    .btn.primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #0d9488 0%, #059669 100%);
      box-shadow: 0 10px 15px -3px rgba(20, 184, 166, 0.5);
    }

    .btn.danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border-color: transparent;
      color: #ffffff;
      font-weight: 600;
      box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
    }

    .btn.danger:hover:not(:disabled) {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.5);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Modern Table Styles */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 0.5rem;
    }

    thead th {
      text-align: left;
      color: rgb(148, 163, 184);
      padding: 0.75rem 1rem;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    tbody td {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(71, 85, 105, 0.3);
      padding: 1rem;
      transition: all 0.2s ease;
      color: rgb(226, 232, 240);
    }

    tbody tr td:first-child {
      border-top-left-radius: 0.5rem;
      border-bottom-left-radius: 0.5rem;
    }

    tbody tr td:last-child {
      border-top-right-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
    }

    tbody tr:hover td {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(20, 184, 166, 0.4);
      box-shadow: 0 0 15px rgba(20, 184, 166, 0.1);
    }

    tbody td.actions {
      white-space: nowrap;
      text-align: right;
    }

    tbody td.actions .action-wrapper {
      display: inline-flex;
      gap: 1rem;
      align-items: center;
      justify-content: flex-end;
      width: 100%;
    }

    tbody td.actions .btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      min-height: auto;
      font-weight: 600;
    }

    /* Modern Badge Styles */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.6875rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      margin: 0;
      white-space: nowrap;
    }

    .badge.active {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.5);
      color: #6ee7b7;
    }

    .badge.expired {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: #fca5a5;
    }

    .badge.none {
      background: rgba(148, 163, 184, 0.15);
      color: rgb(148, 163, 184);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .badge.paid {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.5);
      color: #6ee7b7;
    }

    .badge.unpaid {
      background: rgba(251, 191, 36, 0.15);
      border: 1px solid rgba(251, 191, 36, 0.5);
      color: #fcd34d;
    }

    .badge.booked {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.5);
      color: #93c5fd;
    }

    .badge.pending {
      background: rgba(251, 191, 36, 0.15);
      border: 1px solid rgba(251, 191, 36, 0.5);
      color: #fcd34d;
    }

    /* Schedule grid for reservations */
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 12px;
    }

    .schedule-table th,
    .schedule-table td {
      border: 1px solid var(--border);
      padding: 8px;
      text-align: center;
      transition: var(--transition);
    }

    .schedule-table th {
      background: var(--card);
      color: var(--text);
      font-weight: 600;
    }

    .schedule-table .time-cell {
      font-weight: 600;
      white-space: nowrap;
      background: var(--panel);
      color: var(--muted);
    }

    .schedule-table .reserved {
      background: rgba(59, 130, 246, 0.3);
      border-color: #3b82f6;
      color: #93c5fd;
      cursor: pointer;
    }

    .schedule-table .reserved:hover {
      background: rgba(59, 130, 246, 0.5);
    }

    .schedule-table .event {
      background: rgba(168, 85, 247, 0.3);
      border-color: #a855f7;
      color: #d8b4fe;
      cursor: pointer;
    }

    .schedule-table .event:hover {
      background: rgba(168, 85, 247, 0.5);
    }

    /* Drawer editor */
    /* Modern Drawer Styles */
    .drawer {
      position: fixed;
      top: 68px;
      right: -440px;
      width: 440px;
      max-width: 100vw;
      height: calc(100dvh - 68px);
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(71, 85, 105, 0.5);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
      display: flex;
      flex-direction: column;
    }

    .drawer.open {
      right: 0;
    }

    .drawer header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(71, 85, 105, 0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(20, 184, 166, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
    }

    .drawer h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      letter-spacing: -0.025em;
    }

    .drawer .content {
      padding: 1.5rem;
      flex-grow: 1;
      overflow: auto;
    }

    .drawer .content label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: rgb(226, 232, 240);
      font-size: 0.875rem;
    }

    .drawer .content input,
    .drawer .content select,
    .drawer .content textarea {
      width: 100%;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.6);
      color: white;
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1.25rem;
      outline: none;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }

    .drawer .content input:focus,
    .drawer .content select:focus,
    .drawer .content textarea:focus {
      border-color: #14b8a6;
      box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.15);
      background: rgba(15, 23, 42, 1);
    }

    .drawer .content input::placeholder,
    .drawer .content textarea::placeholder {
      color: rgb(148, 163, 184);
    }

    .drawer .content textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .drawer .content .form-group {
      margin-bottom: 1.5rem;
    }

    .drawer footer {
      padding: 1.5rem;
      border-top: 1px solid rgba(71, 85, 105, 0.5);
      display: flex;
      gap: 0.75rem;
      background: rgba(15, 23, 42, 0.8);
    }

    .drawer footer .btn {
      flex: 1;
    }

    /* Modern Toast Notifications */
    .toast-container {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      max-width: 24rem;
    }

    .toast {
      background: rgba(30, 41, 59, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(71, 85, 105, 0.5);
      border-radius: 0.75rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: white;
    }

    .toast.success {
      border-left: 4px solid #14b8a6;
      box-shadow: 0 20px 25px -5px rgba(20, 184, 166, 0.3);
    }

    .toast.success::before {
      content: "‚úì";
      display: flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      background: #14b8a6;
      border-radius: 9999px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
      box-shadow: 0 20px 25px -5px rgba(239, 68, 68, 0.3);
    }

    .toast.error::before {
      content: "‚úï";
      display: flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      background: #ef4444;
      border-radius: 9999px;
      font-weight: bold;
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
      font-size: 0.875rem;
      line-height: 1.5;
      font-weight: 500;
    }

    @keyframes slideIn {
      from {
        transform: translateX(120%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Loading spinner */
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top: 3px solid var(--brand);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-left: 8px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Responsive: hide right panel on small screens */
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr 0 0;
      }

      .right {
        display: none;
      }

      .left {
        padding: 16px;
      }

      .topbar {
        padding: 12px 16px;
      }

      .topbar h1 {
        font-size: 16px;
      }

      li button {
        padding: 8px 12px;
        font-size: 13px;
      }

      .toolbar {
        gap: 8px;
      }

      .card {
        padding: 16px;
        margin-bottom: 16px;
      }

      table {
        font-size: 13px;
      }

      tbody td {
        padding: 10px 8px;
      }

      .drawer {
        width: 100vw;
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen font-sans text-slate-100">
  <header class="bg-gradient-to-r from-primary-600 to-emerald-500 shadow-2xl sticky top-0 z-40">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-3xl font-bold text-white flex items-center gap-3">
          <span class="text-4xl">üéæ</span>
          Pickleball Admin
        </h1>
      </div>

      <!-- Navigation Tabs -->
      <nav class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
        <ul class="flex gap-2">
          <li><button data-section="players" class="nav-tab active">H·ªôi vi√™n</button></li>
          <li><button data-section="courts" class="nav-tab">S√¢n</button></li>
          <li><button data-section="reservations" class="nav-tab">ƒê·∫∑t s√¢n</button></li>
          <li><button data-section="waitlist" class="nav-tab">Danh s√°ch ch·ªù</button></li>
          <li><button data-section="events" class="nav-tab">S·ª± ki·ªán</button></li>
          <li><button data-section="memberships" class="nav-tab">Th·∫ª h·ªôi vi√™n</button></li>
          <li><button data-section="payments" class="nav-tab">Thanh to√°n</button></li>
          <li><button data-section="notifications" class="nav-tab">Nh·∫Øc nh·ªü</button></li>
          <li><button data-section="messages" class="nav-tab">Tin nh·∫Øn</button></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Main Content Container -->
  <div class="container mx-auto px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Main Content (2/3 width on large screens) -->
      <div class="lg:col-span-2 space-y-6">
        <!-- dynamic content -->
        <div id="section-players" class="section"></div>
        <div id="section-courts" class="section" style="display:none"></div>
        <div id="section-reservations" class="section" style="display:none"></div>
        <div id="section-waitlist" class="section" style="display:none"></div>
        <div id="section-events" class="section" style="display:none"></div>
        <div id="section-memberships" class="section" style="display:none"></div>
        <div id="section-payments" class="section" style="display:none"></div>
        <div id="section-notifications" class="section" style="display:none"></div>
        <div id="section-messages" class="section" style="display:none"></div>
      </div>

      <!-- Right: Schedule Sidebar (1/3 width on large screens) -->
      <div class="lg:col-span-1" id="right-panel">
        <div id="schedule-view" style="display:none" class="space-y-4">
          <h3 class="text-xl font-bold text-white">L·ªãch ƒë·∫∑t s√¢n (7 ng√†y t·ªõi)</h3>
          <div id="schedule-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Drawer for editing -->
  <div class="drawer" id="drawer">
    <header>
      <h3 id="drawer-title">Ch·ªânh s·ª≠a</h3>
      <button class="btn" id="close-drawer">ƒê√≥ng</button>
    </header>
    <div class="content" id="drawer-content"></div>
    <footer>
      <button class="btn danger" id="delete-record" style="display:none">Xo√°</button>
      <button class="btn primary" id="save-record">L∆∞u</button>
    </footer>
  </div>

  <!-- Toast notification container -->
  <div class="toast-container" id="toast-container"></div>

  <script>
      (() => {
        const api = {
          players: {
            list: () => $.getJSON('/api/players'),
            create: (d) => $.ajax({ url: '/api/players', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            patch: (id, d) => $.ajax({ url: '/api/players/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            remove: (id) => $.ajax({ url: '/api/players/' + id, method: 'DELETE' })
          },
          courts: {
            list: () => $.getJSON('/api/courts'),
            create: (d) => $.ajax({ url: '/api/courts', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            patch: (id, d) => $.ajax({ url: '/api/courts/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            remove: (id) => $.ajax({ url: '/api/courts/' + id, method: 'DELETE' })
          },
          reservations: {
            list: (date) => $.getJSON('/api/reservations' + (date ? ('?date=' + date) : '')),
            create: (d) => $.ajax({ url: '/api/reservations', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            patch: (id, d) => $.ajax({ url: '/api/reservations/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            remove: (id) => $.ajax({ url: '/api/reservations/' + id, method: 'DELETE' })
          },
          waitlist: {
            list: () => $.getJSON('/api/waitlist'),
            create: (d) => $.ajax({ url: '/api/waitlist', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            patch: (id, d) => $.ajax({ url: '/api/waitlist/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            remove: (id) => $.ajax({ url: '/api/waitlist/' + id, method: 'DELETE' })
          },
          events: {
            list: () => $.getJSON('/api/events'),
            create: (d) => $.ajax({ url: '/api/events', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            patch: (id, d) => $.ajax({ url: '/api/events/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            remove: (id) => $.ajax({ url: '/api/events/' + id, method: 'DELETE' }),
            registrations: (eid) => $.getJSON('/api/events/' + eid + '/registrations'),
            addRegistration: (eid, d) => $.ajax({ url: '/api/events/' + eid + '/registrations', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            updateRegistration: (id, d) => $.ajax({ url: '/api/event-registrations/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            removeRegistration: (id) => $.ajax({ url: '/api/event-registrations/' + id, method: 'DELETE' })
          },
          membershipPlans: {
            list: () => $.getJSON('/api/membership-plans'),
            create: (d) => $.ajax({ url: '/api/membership-plans', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            patch: (id, d) => $.ajax({ url: '/api/membership-plans/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            remove: (id) => $.ajax({ url: '/api/membership-plans/' + id, method: 'DELETE' })
          },
          memberships: {
            list: () => $.getJSON('/api/memberships'),
            create: (d) => $.ajax({ url: '/api/memberships', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            patch: (id, d) => $.ajax({ url: '/api/memberships/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            remove: (id) => $.ajax({ url: '/api/memberships/' + id, method: 'DELETE' })
          },
          payments: {
            list: () => $.getJSON('/api/payments'),
            create: (d) => $.ajax({ url: '/api/payments', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            patch: (id, d) => $.ajax({ url: '/api/payments/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            remove: (id) => $.ajax({ url: '/api/payments/' + id, method: 'DELETE' })
          },
          notifications: {
            list: () => $.getJSON('/api/notifications-queue'),
            create: (d) => $.ajax({ url: '/api/notifications-queue', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' }),
            patch: (id, d) => $.ajax({ url: '/api/notifications-queue/' + id, method: 'PATCH', data: JSON.stringify(d), contentType: 'application/json' }),
            remove: (id) => $.ajax({ url: '/api/notifications-queue/' + id, method: 'DELETE' })
          },
          messages: {
            list: () => $.getJSON('/api/messages'),
            create: (d) => $.ajax({ url: '/api/messages', method: 'POST', data: JSON.stringify(d), contentType: 'application/json' })
          },
          reports: {
            membership: () => $.getJSON('/api/report/membership'),
            usage: () => $.getJSON('/api/report/reservations-usage'),
            revenue: () => $.getJSON('/api/report/revenue'),
            eventsCalendar: () => $.getJSON('/api/report/events-calendar'),
            messages: () => $.getJSON('/api/report/messages-history'),
            schedule: () => $.getJSON('/api/report/schedule')
          }
        };

        // Toast notification helper
        function showToast(message, type = 'success') {
          const container = $('#toast-container');
          const toast = $('<div class="toast"></div>').addClass(type);
          toast.append(`<div class="toast-message">${message}</div>`);
          container.append(toast);

          setTimeout(() => {
            toast.css('opacity', '0');
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        // Currency formatter helper
        function formatCurrency(cents) {
          if (cents == null) return '0 ‚Ç´';
          const dong = cents; // already in dong, not cents
          return dong.toLocaleString('vi-VN') + ' ‚Ç´';
        }

        // Helper to render table rows for generic data
        function renderTable(container, columns, data, opts = {}) {
          const thead = $('<thead><tr></tr></thead>');
          columns.forEach(col => {
            thead.find('tr').append(`<th>${col.label}</th>`);
          });
          if (opts.actions) {
            thead.find('tr').append('<th class="actions"></th>');
          }
          const tbody = $('<tbody></tbody>');
          if (data.length === 0) {
            tbody.append(`<tr><td colspan="${columns.length + (opts.actions ? 1 : 0)}" style="color:var(--muted);padding:20px;text-align:center;border:1px dashed var(--border);border-radius:8px">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`);
          } else {
            data.forEach(row => {
              const tr = $('<tr></tr>').attr('data-id', row.id);
              // Allow caller to assign custom CSS classes per row (e.g. highlight recent reservations)
              if (opts.rowClass) {
                const cls = opts.rowClass(row);
                if (cls) tr.addClass(cls);
              }
              columns.forEach(col => {
                const val = row[col.key];
                // Format expiry badge
                if (col.key === 'status' && opts.badge) {
                  const cls = row.status;
                  tr.append(`<td><span class="badge ${cls}">${val}</span></td>`);
                } else {
                  tr.append(`<td>${val != null ? val : ''}</td>`);
                }
              });
              if (opts.actions) {
                const td = $('<td class="actions"></td>');
                const actionsWrapper = $('<div class="action-wrapper"></div>');
                if (opts.onEdit) {
                  actionsWrapper.append(`<button class="btn" data-action="edit">S·ª≠a</button>`);
                }
                if (opts.onDelete) {
                  actionsWrapper.append(`<button class="btn danger" data-action="delete">Xo√°</button>`);
                }
                // Append payment button or badge if enabled
                if (opts.payButton) {
                  if (row.payment_status && row.payment_status === 'paid') {
                    actionsWrapper.append(`<span class="badge paid">ƒê√£ TT</span>`);
                  } else {
                    actionsWrapper.append(`<button class="btn primary" data-action="pay">Thanh to√°n</button>`);
                  }
                }
                td.append(actionsWrapper);
                tr.append(td);
              }
              tbody.append(tr);
            });
          }
          container.empty().append($('<table></table>').append(thead).append(tbody));
        }

        // Drawer handling
        let drawerMode = null; // e.g. 'players', 'courts'
        let currentId = null;
        let originalRecord = null;
        function openDrawer(title, record, mode) {
          drawerMode = mode;
          currentId = record ? record.id : null;
          originalRecord = record ? { ...record } : null;
          $('#drawer-title').text(title);
          $('#drawer-content').empty();
          // dynamic form fields based on mode
          const fieldsDef = modules[mode].fields;
          fieldsDef.forEach(f => {
            const field = $('<div class="field"></div>');
            field.append(`<label>${f.label}</label>`);
            let input;
            if (f.type === 'select') {
              input = $('<select></select>').attr('id', 'f_' + f.key);
              (f.options || []).forEach(opt => {
                input.append(`<option value="${opt.value}">${opt.text}</option>`);
              });
            } else if (f.type === 'textarea') {
              input = $('<textarea></textarea>').attr('id', 'f_' + f.key).attr('rows', 3);
            } else {
              input = $('<input />').attr('id', 'f_' + f.key).attr('type', f.type || 'text');
            }
            field.append(input);
            $('#drawer-content').append(field);
          });
          // fill values if record exists
          if (record) {
            fieldsDef.forEach(f => {
              $('#f_' + f.key).val(record[f.key] != null ? record[f.key] : '');
            });
          } else {
            fieldsDef.forEach(f => {
              $('#f_' + f.key).val(f.default || '');
            });
            // Prefill reservation datetime fields based on currently selected date in Reservations view
            if (mode === 'reservations') {
              let selDate = $('#section-reservations .toolbar input[type=date]').val();
              if (!selDate) {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                selDate = `${y}-${m}-${day}`;
              }
              // If selected date is today, default to next full hour; else 00:00-01:00
              const nowLocal = new Date();
              const y2 = nowLocal.getFullYear();
              const m2 = String(nowLocal.getMonth() + 1).padStart(2, '0');
              const d2 = String(nowLocal.getDate()).padStart(2, '0');
              const todayStr = `${y2}-${m2}-${d2}`;
              let startHour;
              if (selDate === todayStr) {
                startHour = nowLocal.getHours() + 1;
                if (startHour < 6) startHour = 6;
                if (startHour > 21) startHour = 21;
              } else {
                startHour = 0;
              }
              const endHour = startHour + 1;
              const pad2 = (n) => String(n).padStart(2, '0');
              $('#f_start_time').val(selDate + 'T' + pad2(startHour) + ':00');
              $('#f_end_time').val(selDate + 'T' + pad2(endHour) + ':00');
            }
          }
          // toggle delete button
          if (modules[mode].remove) {
            $('#delete-record').show();
          } else {
            $('#delete-record').hide();
          }
          $('#drawer').addClass('open');
        }
        function closeDrawer() {
          $('#drawer').removeClass('open');
          drawerMode = null;
          currentId = null;
          originalRecord = null;
        }
        $('#close-drawer').on('click', closeDrawer);

        $('#save-record').on('click', async () => {
          if (!drawerMode) return;
          const mod = modules[drawerMode];
          const data = {};
          mod.fields.forEach(f => {
            data[f.key] = $('#f_' + f.key).val();
          });
          try {
            let result;
            if (currentId) {
              // diff for patch
              const patch = {};
              for (const k in data) {
                if (!originalRecord || data[k] != originalRecord[k]) patch[k] = data[k];
              }
              if (Object.keys(patch).length === 0) {
                showToast('Kh√¥ng c√≥ g√¨ thay ƒë·ªïi.', 'error');
                return;
              }
              result = await mod.patch(currentId, patch);
            } else {
              result = await mod.create(data);
            }
            // Special handling: if editing waitlist and a reservation is created (no priority field)
            if (drawerMode === 'waitlist' && result && result.priority === undefined) {
              showToast('Y√™u c·∫ßu ch·ªù ƒë√£ ƒë∆∞·ª£c chuy·ªÉn th√†nh ƒë·∫∑t s√¢n.', 'success');
              // refresh both waitlist and reservations lists
              await modules.waitlist.load();
              await modules.reservations.load();
              closeDrawer();
              return;
            }
            await mod.load();
            closeDrawer();
            showToast(currentId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m m·ªõi th√†nh c√¥ng!', 'success');
          } catch (err) {
            showToast(err.responseJSON ? err.responseJSON.error : err.statusText, 'error');
          }
        });
        $('#delete-record').on('click', async () => {
          if (!drawerMode || !currentId) return;
          if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√°?')) return;
          try {
            await modules[drawerMode].remove(currentId);
            await modules[drawerMode].load();
            closeDrawer();
            showToast('Xo√° th√†nh c√¥ng!', 'success');
          } catch (err) {
            showToast(err.responseJSON ? err.responseJSON.error : err.statusText, 'error');
          }
        });

        // Modules for each section
        const modules = {
          players: {
            fields: [
              { key: 'name', label: 'T√™n', type: 'text' },
              { key: 'phone', label: 'ƒêi·ªán tho·∫°i', type: 'text' },
              { key: 'email', label: 'Email', type: 'text' },
              { key: 'status', label: 'T√¨nh tr·∫°ng', type: 'select', options: [{ value: 'active', text: 'C√≤n h·∫°n' }, { value: 'expired', text: 'H·∫øt h·∫°n' }, { value: 'none', text: 'Kh√¥ng' }] },
              { key: 'expiry', label: 'Ng√†y h·∫øt h·∫°n', type: 'date' }
            ],
            load: async function () {
              const data = await api.players.list();
              // Remove duplicate entries by unique id
              const dedup = [];
              data.forEach(row => {
                if (!dedup.some(item => item.id === row.id)) dedup.push(row);
              });
              this.data = dedup;
              const container = $('#section-players');
              // toolbar
              const toolbar = $('<div class="toolbar"></div>');
              const qInput = $('<input placeholder="T√¨m theo t√™n/ƒëi·ªán tho·∫°i/email..."/>');
              const statusSel = $('<select><option value="">T·∫•t c·∫£</option><option value="active">C√≤n h·∫°n</option><option value="expired">H·∫øt h·∫°n</option><option value="none">Kh√¥ng</option></select>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              const addBtn = $('<button class="btn primary">Th√™m</button>').on('click', () => {
                openDrawer('Th√™m h·ªôi vi√™n', null, 'players');
              });
              toolbar.append(qInput, statusSel, refreshBtn, addBtn);
              // table container
              const tableContainer = $('<div></div>');
              // helper to render the table based on current filter values
              const renderList = () => {
                const q = qInput.val() || '';
                const st = statusSel.val();
                const filtered = this.data.filter(row => {
                  const hits = row.name.toLowerCase().includes(q.toLowerCase()) ||
                    (row.phone || '').toLowerCase().includes(q.toLowerCase()) ||
                    (row.email || '').toLowerCase().includes(q.toLowerCase());
                  const statusMatch = st ? (row.status === st) : true;
                  return hits && statusMatch;
                });
                // Render the filtered table
                renderTable(tableContainer,
                  [
                    { key: 'name', label: 'T√™n' },
                    { key: 'phone', label: 'Li√™n h·ªá' },
                    { key: 'status', label: 'H·ªôi vi√™n' },
                    { key: 'expiry', label: 'H·∫øt h·∫°n' }
                  ],
                  filtered,
                  {
                    actions: true,
                    badge: true,
                    onEdit: true,
                    onDelete: true
                  }
                );
              };
              // initial render
              renderList();
              // bind actions after each render via event delegation
              tableContainer.off('click').on('click', 'button[data-action]', (e) => {
                const id = parseInt($(e.target).closest('tr').data('id'), 10);
                const row = this.data.find(r => r.id === id);
                const action = $(e.target).data('action');
                if (action === 'edit') {
                  openDrawer('S·ª≠a h·ªôi vi√™n', row, 'players');
                } else if (action === 'delete') {
                  if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° h·ªôi vi√™n n√†y?')) {
                    api.players.remove(id).then(() => this.load());
                  }
                }
              });
              container.empty().append($('<div class="card"></div>').append(toolbar, tableContainer));
              // filter events: do not reload data, just re-render list
              qInput.on('input', renderList);
              statusSel.on('change', renderList);
            },
            create: (d) => api.players.create(d),
            patch: (id, d) => api.players.patch(id, d),
            remove: (id) => api.players.remove(id)
          },
          courts: {
            fields: [
              { key: 'name', label: 'T√™n s√¢n', type: 'text' },
              { key: 'location', label: 'V·ªã tr√≠', type: 'text' },
              { key: 'surface', label: 'M·∫∑t s√¢n', type: 'text' },
              { key: 'indoor', label: 'Trong nh√†', type: 'select', options: [{ value: '0', text: 'Kh√¥ng' }, { value: '1', text: 'C√≥' }] },
              { key: 'lights', label: 'ƒê√®n', type: 'select', options: [{ value: '0', text: 'Kh√¥ng' }, { value: '1', text: 'C√≥' }] },
              { key: 'is_active', label: 'Ho·∫°t ƒë·ªông', type: 'select', options: [{ value: '1', text: 'C√≥' }, { value: '0', text: 'Kh√¥ng' }] }
            ],
            load: async function () {
              const data = await api.courts.list();
              // Remove duplicates by id
              const dedup = [];
              data.forEach(row => {
                if (!dedup.some(item => item.id === row.id)) dedup.push(row);
              });
              this.data = dedup;
              const container = $('#section-courts');
              const toolbar = $('<div class="toolbar"></div>');
              const qInput = $('<input placeholder="T√¨m theo t√™n/v·ªã tr√≠..."/>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              const addBtn = $('<button class="btn primary">Th√™m</button>').on('click', () => {
                openDrawer('Th√™m s√¢n', null, 'courts');
              });
              toolbar.append(qInput, refreshBtn, addBtn);
              const list = this.data.filter(row => {
                const q = qInput.val() || '';
                const hits = row.name.toLowerCase().includes(q.toLowerCase()) || (row.location || '').toLowerCase().includes(q.toLowerCase());
                return hits;
              });
              const tableContainer = $('<div></div>');
              renderTable(tableContainer,
                [
                  { key: 'name', label: 'T√™n' },
                  { key: 'location', label: 'V·ªã tr√≠' },
                  { key: 'surface', label: 'M·∫∑t s√¢n' },
                  { key: 'indoor', label: 'Trong nh√†' },
                  { key: 'lights', label: 'ƒê√®n' },
                  { key: 'is_active', label: 'Ho·∫°t ƒë·ªông' }
                ],
                list,
                {
                  actions: true,
                  onEdit: true,
                  onDelete: true
                }
              );
              tableContainer.on('click', 'button[data-action]', (e) => {
                const id = parseInt($(e.target).closest('tr').data('id'), 10);
                const row = this.data.find(r => r.id === id);
                const action = $(e.target).data('action');
                if (action === 'edit') {
                  openDrawer('S·ª≠a s√¢n', row, 'courts');
                } else if (action === 'delete') {
                  if (confirm('Xo√° s√¢n n√†y?')) {
                    api.courts.remove(id).then(() => this.load());
                  }
                }
              });
              container.empty().append($('<div class="card"></div>').append(toolbar, tableContainer));
              qInput.on('input', () => this.load());
            },
            create: (d) => api.courts.create({
              name: d.name,
              location: d.location,
              surface: d.surface,
              indoor: parseInt(d.indoor || '0', 10),
              lights: parseInt(d.lights || '0', 10),
              is_active: parseInt(d.is_active || '1', 10)
            }),
            patch: (id, d) => api.courts.patch(id, d),
            remove: (id) => api.courts.remove(id)
          },
          reservations: {
            fields: [
              { key: 'court_id', label: 'S√¢n', type: 'select', options: [] },
              { key: 'player_id', label: 'Ng∆∞·ªùi ƒë·∫∑t', type: 'select', options: [] },
              { key: 'start_time', label: 'B·∫Øt ƒë·∫ßu', type: 'datetime-local' },
              { key: 'end_time', label: 'K·∫øt th√∫c', type: 'datetime-local' },
              { key: 'status', label: 'Tr·∫°ng th√°i', type: 'select', options: [{ value: 'booked', text: 'ƒêang ƒë·∫∑t' }, { value: 'completed', text: 'Ho√†n th√†nh' }, { value: 'cancelled', text: 'H·ªßy' }] },
              { key: 'price_cents', label: 'Ph√≠ (VND)', type: 'number' },
              { key: 'payment_status', label: 'Thanh to√°n', type: 'select', options: [{ value: 'unpaid', text: 'Ch∆∞a thanh to√°n' }, { value: 'paid', text: 'ƒê√£ thanh to√°n' }] }
            ],
            load: async function () {
              // fetch reservations and remove duplicates by id
              const data = await api.reservations.list();
              const dedup = [];
              data.forEach(row => {
                if (!dedup.some(item => item.id === row.id)) dedup.push(row);
              });
              // keep all reservations even if there are multiple for the same slot; do not deduplicate by time
              this.data = dedup;
              // fetch all events once for grid overlay
              const eventsData = await api.events.list();
              // preload courts list for grid rendering and filters
              const courts = await api.courts.list();
              const container = $('#section-reservations');
              const toolbar = $('<div class="toolbar"></div>');
              // search and filters
              const qInput = $('<input placeholder="T√¨m theo t√™n/s√¢n..."/>');
              const courtSel = $('<select></select>');
              courtSel.append('<option value="">T·∫•t c·∫£ s√¢n</option>');
              courts.forEach(c => {
                courtSel.append(`<option value="${c.id}">${c.name}</option>`);
              });
              const prevBtn = $('<button class="btn" title="Ng√†y tr∆∞·ªõc">‚Üê</button>');
              const dateInput = $('<input type="date"/>');
              const nextBtn = $('<button class="btn" title="Ng√†y k·∫ø ti·∫øp">‚Üí</button>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              const addBtn = $('<button class="btn primary">Th√™m</button>').on('click', async () => {
                const courtsOpt = await api.courts.list();
                const players = await api.players.list();
                this.fields.find(f => f.key === 'court_id').options = courtsOpt.map(c => ({ value: c.id, text: c.name }));
                this.fields.find(f => f.key === 'player_id').options = players.map(p => ({ value: p.id, text: p.name }));
                openDrawer('Th√™m ƒë·∫∑t s√¢n', null, 'reservations');
              });
              // assemble toolbar: search, court filter, prev/date/next, refresh and add
              toolbar.append(qInput, courtSel, prevBtn, dateInput, nextBtn, refreshBtn, addBtn);
              const tableContainer = $('<div></div>');
              const gridContainer = $('<div></div>').css('margin-top', '16px');
              // helper to render list and grid based on filters
              // format a Date as local YYYY-MM-DD (for <input type="date">)
              const formatLocalDate = (d) => {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
              };

              const renderListAndGrid = () => {
                const q = (qInput.val() || '').toLowerCase();
                const selectedCourt = courtSel.val();
                const d = dateInput.val();
                // filter list
                const list = this.data.filter(row => {
                  // search by player name or court name
                  const matchesQ = !q || (row.player_name && row.player_name.toLowerCase().includes(q)) || (row.court_name && row.court_name.toLowerCase().includes(q));
                  // filter by court
                  const matchesCourt = selectedCourt ? (row.court_id === parseInt(selectedCourt, 10)) : true;
                  // filter by date if selected
                  const matchesDate = d ? row.start_time.slice(0, 10) === d : true;
                  return matchesQ && matchesCourt && matchesDate;
                });
                // compute payment label and nearest upcoming reservation id
                const now = new Date();
                let nearestDiff = Infinity;
                let nearestId = null;
                list.forEach(r => {
                  // label
                  r.payment_label = `<span class="badge ${r.payment_status === 'paid' ? 'paid' : 'unpaid'}">${r.payment_status === 'paid' ? 'ƒê√£ TT' : 'Ch∆∞a TT'}</span>`;
                  // compute upcoming difference
                  try {
                    const st = new Date(r.start_time.replace(' ', 'T'));
                    const diff = st - now;
                    if (diff >= 0 && diff < nearestDiff) {
                      nearestDiff = diff;
                      nearestId = r.id;
                    }
                  } catch (e) { }
                });
                // Render table with payment info
                renderTable(tableContainer,
                  [
                    { key: 'court_name', label: 'S√¢n' },
                    { key: 'player_name', label: 'Ng∆∞·ªùi ƒë·∫∑t' },
                    { key: 'start_time', label: 'B·∫Øt ƒë·∫ßu' },
                    { key: 'end_time', label: 'K·∫øt th√∫c' },
                    { key: 'status', label: 'Tr·∫°ng th√°i' },
                    { key: 'payment_label', label: 'Thanh to√°n' }
                  ],
                  list,
                  {
                    actions: true,
                    onEdit: true,
                    onDelete: true,
                    payButton: true
                  }
                );
                // Render grid only when a date is selected
                gridContainer.empty();
                if (d && courts && courts.length > 0) {
                  const hours = [];
                  for (let h = 6; h < 22; h++) hours.push(h);
                  const table = $('<table class="schedule-table"></table>');
                  const header = $('<tr></tr>');
                  header.append('<th class="time-cell">Th·ªùi gian</th>');
                  courts.forEach(c => {
                    header.append(`<th>${c.name}</th>`);
                  });
                  table.append(header);
                  hours.forEach(h => {
                    const rowTr = $('<tr></tr>');
                    const startLabel = (h < 10 ? '0' : '') + h + ':00';
                    const endLabel = (h + 1 < 10 ? '0' : '') + (h + 1) + ':00';
                    rowTr.append(`<td class="time-cell">${startLabel} - ${endLabel}</td>`);
                    courts.forEach(c => {
                      const cell = $('<td></td>');
                      // check reservations overlapping this hour for this court
                      list.forEach(r => {
                        if (r.court_id === c.id) {
                          const sH = parseInt(r.start_time.substr(11, 2), 10);
                          const sM = parseInt(r.start_time.substr(14, 2), 10);
                          const eH = parseInt(r.end_time.substr(11, 2), 10);
                          const eM = parseInt(r.end_time.substr(14, 2), 10);
                          const startMin = sH * 60 + sM;
                          const endMin = eH * 60 + eM;
                          const cellStart = h * 60;
                          const cellEnd = (h + 1) * 60;
                          if (startMin < cellEnd && endMin > cellStart) {
                            cell.addClass('reserved');
                            cell.attr('title', r.player_name + ' ' + r.start_time.substr(11, 5) + '-' + r.end_time.substr(11, 5));
                          }
                        }
                      });
                      // check events overlapping this hour for this court or all courts
                      const eventsOnDate = eventsData.filter(ev => {
                        if (!ev.start_time || !ev.end_time) return false;
                        const startDate = ev.start_time.slice(0, 10);
                        const endDate = ev.end_time.slice(0, 10);
                        return (startDate <= d && endDate >= d);
                      });
                      eventsOnDate.forEach(ev => {
                        if (ev.court_id === c.id || ev.court_id == null) {
                          const eSH = parseInt(ev.start_time.substr(11, 2), 10);
                          const eSM = parseInt(ev.start_time.substr(14, 2), 10);
                          const eEH = parseInt(ev.end_time.substr(11, 2), 10);
                          const eEM = parseInt(ev.end_time.substr(14, 2), 10);
                          const evStartMin = eSH * 60 + eSM;
                          const evEndMin = eEH * 60 + eEM;
                          const cellStart = h * 60;
                          const cellEnd = (h + 1) * 60;
                          if (evStartMin < cellEnd && evEndMin > cellStart) {
                            cell.removeClass('reserved');
                            cell.addClass('event');
                            cell.attr('title', (ev.name || 'S·ª± ki·ªán') + ' ' + ev.start_time.substr(11, 5) + '-' + ev.end_time.substr(11, 5));
                          }
                        }
                      });
                      rowTr.append(cell);
                    });
                    table.append(rowTr);
                  });
                  gridContainer.append($('<div class="card"></div>').append('<h3>L·ªãch theo gi·ªù</h3>', table));
                }
              };
              // set default date to today
              (function setDefaultDate() {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                dateInput.val(`${y}-${m}-${d}`);
              }).call(this);
              // initial render
              renderListAndGrid();
              // handle actions on table rows
              tableContainer.off('click').on('click', 'button[data-action]', async (e) => {
                const id = parseInt($(e.target).closest('tr').data('id'), 10);
                const row = this.data.find(r => r.id === id);
                const action = $(e.target).data('action');
                if (action === 'edit') {
                  const courtsOpt = await api.courts.list();
                  const players = await api.players.list();
                  this.fields.find(f => f.key === 'court_id').options = courtsOpt.map(c => ({ value: c.id, text: c.name }));
                  this.fields.find(f => f.key === 'player_id').options = players.map(p => ({ value: p.id, text: p.name }));
                  const rcopy = { ...row };
                  rcopy.start_time = row.start_time.replace(' ', 'T');
                  rcopy.end_time = row.end_time.replace(' ', 'T');
                  openDrawer('S·ª≠a ƒë·∫∑t s√¢n', rcopy, 'reservations');
                } else if (action === 'delete') {
                  if (confirm('Xo√° ƒë·∫∑t s√¢n n√†y?')) {
                    api.reservations.remove(id).then(() => this.load());
                  }
                } else if (action === 'pay') {
                  // Set pending payment and switch to payments tab
                  window.pendingPaymentReservation = row;
                  $('nav button[data-section="payments"]').click();
                }
              });
              // append content
              container.empty().append($('<div class="card"></div>').append(toolbar, tableContainer, gridContainer));
              // filter change events
              qInput.on('input', renderListAndGrid);
              courtSel.on('change', renderListAndGrid);
              dateInput.on('change', renderListAndGrid);
              // next/prev buttons adjust date
              prevBtn.on('click', async () => {
                let current = dateInput.val();
                let dt;
                if (current) dt = new Date(current + 'T00:00:00'); else dt = new Date();
                dt.setDate(dt.getDate() - 1);
                // Use local date string to avoid UTC shift issues
                dateInput.val(formatLocalDate(dt)).trigger('change');
              });
              nextBtn.on('click', async () => {
                let current = dateInput.val();
                let dt;
                if (current) dt = new Date(current + 'T00:00:00'); else dt = new Date();
                dt.setDate(dt.getDate() + 1);
                // Use local date string to avoid UTC shift issues
                dateInput.val(formatLocalDate(dt)).trigger('change');
              });
              // show schedule in right panel
              $('#schedule-view').show();
              loadSchedule();
            },
            create: (d) => api.reservations.create({
              court_id: parseInt(d.court_id, 10),
              player_id: parseInt(d.player_id, 10),
              start_time: d.start_time.replace('T', ' '),
              end_time: d.end_time.replace('T', ' '),
              status: d.status,
              price_cents: parseInt(d.price_cents || '0', 10)
            }),
            patch: (id, d) => {
              if (d.start_time) d.start_time = d.start_time.replace('T', ' ');
              if (d.end_time) d.end_time = d.end_time.replace('T', ' ');
              return api.reservations.patch(id, d);
            },
            remove: (id) => api.reservations.remove(id)
          },
          waitlist: {
            fields: [
              { key: 'court_id', label: 'S√¢n', type: 'select', options: [] },
              { key: 'player_id', label: 'Ng∆∞·ªùi ƒëƒÉng k√Ω', type: 'select', options: [] },
              { key: 'start_time', label: 'B·∫Øt ƒë·∫ßu', type: 'datetime-local' },
              { key: 'end_time', label: 'K·∫øt th√∫c', type: 'datetime-local' },
              { key: 'priority', label: '∆Øu ti√™n', type: 'number' },
              { key: 'status', label: 'Tr·∫°ng th√°i', type: 'select', options: [{ value: 'waiting', text: 'ƒê·ª£i' }, { value: 'notified', text: 'ƒê√£ th√¥ng b√°o' }, { value: 'booked', text: 'ƒê√£ ƒë·∫∑t' }, { value: 'cancelled', text: 'H·ªßy' }, { value: 'expired', text: 'H·∫øt h·∫°n' }] }
            ],
            load: async function () {
              const data = await api.waitlist.list();
              // Remove duplicates by id
              const dedup = [];
              data.forEach(row => {
                if (!dedup.some(item => item.id === row.id)) dedup.push(row);
              });
              this.data = dedup;
              const container = $('#section-waitlist');
              const toolbar = $('<div class="toolbar"></div>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              const addBtn = $('<button class="btn primary">Th√™m</button>').on('click', async () => {
                const courts = await api.courts.list();
                const players = await api.players.list();
                this.fields.find(f => f.key === 'court_id').options = courts.map(c => ({ value: c.id, text: c.name }));
                this.fields.find(f => f.key === 'player_id').options = players.map(p => ({ value: p.id, text: p.name }));
                openDrawer('Th√™m h√†ng ch·ªù', null, 'waitlist');
              });
              toolbar.append(refreshBtn, addBtn);
              const tableContainer = $('<div></div>');
              renderTable(tableContainer,
                [
                  { key: 'court_name', label: 'S√¢n' },
                  { key: 'player_name', label: 'Ng∆∞·ªùi ƒë·ª£i' },
                  { key: 'start_time', label: 'B·∫Øt ƒë·∫ßu' },
                  { key: 'end_time', label: 'K·∫øt th√∫c' },
                  { key: 'priority', label: '∆Øu ti√™n' },
                  { key: 'status', label: 'Tr·∫°ng th√°i' }
                ],
                data,
                { actions: true, onEdit: true, onDelete: true }
              );
              tableContainer.on('click', 'button[data-action]', async (e) => {
                const id = parseInt($(e.target).closest('tr').data('id'), 10);
                const row = this.data.find(r => r.id === id);
                const action = $(e.target).data('action');
                if (action === 'edit') {
                  const courts = await api.courts.list();
                  const players = await api.players.list();
                  this.fields.find(f => f.key === 'court_id').options = courts.map(c => ({ value: c.id, text: c.name }));
                  this.fields.find(f => f.key === 'player_id').options = players.map(p => ({ value: p.id, text: p.name }));
                  const rcopy = { ...row };
                  rcopy.start_time = row.start_time.replace(' ', 'T');
                  rcopy.end_time = row.end_time.replace(' ', 'T');
                  openDrawer('S·ª≠a h√†ng ch·ªù', rcopy, 'waitlist');
                } else if (action === 'delete') {
                  if (confirm('Xo√°?')) {
                    api.waitlist.remove(id).then(() => this.load());
                  }
                }
              });
              container.empty().append($('<div class="card"></div>').append(toolbar, tableContainer));
            },
            create: (d) => api.waitlist.create({
              court_id: parseInt(d.court_id, 10),
              player_id: parseInt(d.player_id, 10),
              start_time: d.start_time.replace('T', ' '),
              end_time: d.end_time.replace('T', ' '),
              priority: parseInt(d.priority || '0', 10),
              status: d.status
            }),
            patch: (id, d) => {
              if (d.start_time) d.start_time = d.start_time.replace('T', ' ');
              if (d.end_time) d.end_time = d.end_time.replace('T', ' ');
              return api.waitlist.patch(id, d);
            },
            remove: (id) => api.waitlist.remove(id)
          },
          events: {
            fields: [
              { key: 'name', label: 'T√™n s·ª± ki·ªán', type: 'text' },
              { key: 'description', label: 'M√¥ t·∫£', type: 'textarea' },
              { key: 'court_id', label: 'S√¢n', type: 'select', options: [] },
              { key: 'start_time', label: 'B·∫Øt ƒë·∫ßu', type: 'datetime-local' },
              { key: 'end_time', label: 'K·∫øt th√∫c', type: 'datetime-local' },
              { key: 'max_participants', label: 'S·ªë ng∆∞·ªùi t·ªëi ƒëa', type: 'number' },
              { key: 'fee_cents', label: 'Ph√≠ (VND)', type: 'number' },
              { key: 'status', label: 'Tr·∫°ng th√°i', type: 'select', options: [{ value: 'draft', text: 'Nh√°p' }, { value: 'open', text: 'M·ªü ƒëƒÉng k√Ω' }, { value: 'full', text: 'ƒê·∫ßy' }, { value: 'closed', text: 'ƒê√≥ng' }, { value: 'cancelled', text: 'H·ªßy' }] }
            ],
            load: async function () {
              const data = await api.events.list();
              // Remove duplicates by id
              const dedup = [];
              data.forEach(row => {
                if (!dedup.some(item => item.id === row.id)) dedup.push(row);
              });
              this.data = dedup;
              const container = $('#section-events');
              const toolbar = $('<div class="toolbar"></div>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              const addBtn = $('<button class="btn primary">Th√™m</button>').on('click', async () => {
                const courts = await api.courts.list();
                this.fields.find(f => f.key === 'court_id').options = [{ value: '', text: '(Kh√¥ng)' }].concat(courts.map(c => ({ value: c.id, text: c.name })));
                openDrawer('Th√™m s·ª± ki·ªán', null, 'events');
              });
              toolbar.append(refreshBtn, addBtn);
              const tableContainer = $('<div></div>');
              renderTable(tableContainer,
                [
                  { key: 'name', label: 'T√™n' },
                  { key: 'court_name', label: 'S√¢n' },
                  { key: 'start_time', label: 'B·∫Øt ƒë·∫ßu' },
                  { key: 'end_time', label: 'K·∫øt th√∫c' },
                  { key: 'max_participants', label: 'T·ªëi ƒëa' },
                  { key: 'fee_cents', label: 'Ph√≠' },
                  { key: 'status', label: 'Tr·∫°ng th√°i' }
                ],
                data,
                { actions: true, onEdit: true, onDelete: true }
              );
              tableContainer.on('click', 'button[data-action]', async (e) => {
                const id = parseInt($(e.target).closest('tr').data('id'), 10);
                const row = this.data.find(r => r.id === id);
                const action = $(e.target).data('action');
                if (action === 'edit') {
                  const courts = await api.courts.list();
                  this.fields.find(f => f.key === 'court_id').options = [{ value: '', text: '(Kh√¥ng)' }].concat(courts.map(c => ({ value: c.id, text: c.name })));
                  const rcopy = { ...row };
                  rcopy.start_time = row.start_time.replace(' ', 'T');
                  rcopy.end_time = row.end_time.replace(' ', 'T');
                  openDrawer('S·ª≠a s·ª± ki·ªán', rcopy, 'events');
                } else if (action === 'delete') {
                  if (confirm('Xo√° s·ª± ki·ªán?')) {
                    api.events.remove(id).then(() => this.load());
                  }
                }
              });
              container.empty().append($('<div class="card"></div>').append(toolbar, tableContainer));
            },
            create: (d) => api.events.create({
              name: d.name,
              description: d.description,
              court_id: d.court_id ? parseInt(d.court_id, 10) : null,
              start_time: d.start_time.replace('T', ' '),
              end_time: d.end_time.replace('T', ' '),
              max_participants: d.max_participants ? parseInt(d.max_participants, 10) : null,
              fee_cents: parseInt(d.fee_cents || '0', 10),
              status: d.status
            }),
            patch: (id, d) => {
              if (d.start_time) d.start_time = d.start_time.replace('T', ' ');
              if (d.end_time) d.end_time = d.end_time.replace('T', ' ');
              if (d.court_id === '') d.court_id = null;
              return api.events.patch(id, d);
            },
            remove: (id) => api.events.remove(id)
          },
          memberships: {
            fields: [
              { key: 'player_id', label: 'H·ªôi vi√™n', type: 'select', options: [] },
              { key: 'plan_id', label: 'G√≥i', type: 'select', options: [] },
              { key: 'start_date', label: 'Ng√†y b·∫Øt ƒë·∫ßu', type: 'date' },
              { key: 'end_date', label: 'Ng√†y k·∫øt th√∫c', type: 'date' },
              { key: 'status', label: 'Tr·∫°ng th√°i', type: 'select', options: [{ value: 'active', text: 'C√≤n h·∫°n' }, { value: 'expired', text: 'H·∫øt h·∫°n' }, { value: 'pending', text: 'Ch·ªù' }, { value: 'cancelled', text: 'H·ªßy' }] }
            ],
            load: async function () {
              const data = await api.memberships.list();
              // Remove duplicates by id
              const dedup = [];
              data.forEach(row => {
                if (!dedup.some(item => item.id === row.id)) dedup.push(row);
              });
              this.data = dedup;
              const container = $('#section-memberships');
              const toolbar = $('<div class="toolbar"></div>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              const addBtn = $('<button class="btn primary">Th√™m</button>').on('click', async () => {
                const players = await api.players.list();
                const plans = await api.membershipPlans.list();
                this.fields.find(f => f.key === 'player_id').options = players.map(p => ({ value: p.id, text: p.name }));
                this.fields.find(f => f.key === 'plan_id').options = plans.map(p => ({ value: p.id, text: p.name }));
                openDrawer('Th√™m th·∫ª h·ªôi vi√™n', null, 'memberships');
              });
              toolbar.append(refreshBtn, addBtn);
              const tableContainer = $('<div></div>');
              renderTable(tableContainer,
                [
                  { key: 'player_name', label: 'H·ªôi vi√™n' },
                  { key: 'plan_name', label: 'G√≥i' },
                  { key: 'start_date', label: 'B·∫Øt ƒë·∫ßu' },
                  { key: 'end_date', label: 'K·∫øt th√∫c' },
                  { key: 'status', label: 'Tr·∫°ng th√°i' }
                ],
                data,
                { actions: true, onEdit: true, onDelete: true }
              );
              tableContainer.on('click', 'button[data-action]', async (e) => {
                const id = parseInt($(e.target).closest('tr').data('id'), 10);
                const row = this.data.find(r => r.id === id);
                const action = $(e.target).data('action');
                if (action === 'edit') {
                  const players = await api.players.list();
                  const plans = await api.membershipPlans.list();
                  this.fields.find(f => f.key === 'player_id').options = players.map(p => ({ value: p.id, text: p.name }));
                  this.fields.find(f => f.key === 'plan_id').options = plans.map(p => ({ value: p.id, text: p.name }));
                  const rcopy = { ...row };
                  rcopy.start_date = row.start_date;
                  rcopy.end_date = row.end_date;
                  openDrawer('S·ª≠a th·∫ª h·ªôi vi√™n', rcopy, 'memberships');
                } else if (action === 'delete') {
                  if (confirm('Xo√° th·∫ª h·ªôi vi√™n?')) {
                    api.memberships.remove(id).then(() => this.load());
                  }
                }
              });
              container.empty().append($('<div class="card"></div>').append(toolbar, tableContainer));
            },
            create: (d) => api.memberships.create({
              player_id: parseInt(d.player_id, 10),
              plan_id: parseInt(d.plan_id, 10),
              start_date: d.start_date,
              end_date: d.end_date,
              status: d.status
            }),
            patch: (id, d) => api.memberships.patch(id, d),
            remove: (id) => api.memberships.remove(id)
          },
          payments: {
            fields: [
              { key: 'player_id', label: 'H·ªôi vi√™n', type: 'select', options: [] },
              { key: 'amount_cents', label: 'S·ªë ti·ªÅn', type: 'number' },
              { key: 'currency', label: 'Ti·ªÅn t·ªá', type: 'text', default: 'VND' },
              { key: 'source_type', label: 'Lo·∫°i ngu·ªìn', type: 'text' },
              { key: 'source_id', label: 'ID ngu·ªìn', type: 'number' },
              { key: 'method', label: 'Ph∆∞∆°ng th·ª©c', type: 'text' },
              { key: 'status', label: 'Tr·∫°ng th√°i', type: 'select', options: [{ value: 'pending', text: 'ƒêang x·ª≠ l√Ω' }, { value: 'succeeded', text: 'Th√†nh c√¥ng' }, { value: 'failed', text: 'Th·∫•t b·∫°i' }, { value: 'refunded', text: 'ƒê√£ ho√†n ti·ªÅn' }, { value: 'partial', text: 'Ho√†n 1 ph·∫ßn' }] }
            ],
            load: async function () {
              const data = await api.payments.list();
              // Remove duplicates by id
              const dedup = [];
              data.forEach(row => {
                if (!dedup.some(item => item.id === row.id)) dedup.push(row);
              });
              this.data = dedup;
              const container = $('#section-payments');
              const toolbar = $('<div class="toolbar"></div>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              const addBtn = $('<button class="btn primary">Th√™m</button>').on('click', async () => {
                const players = await api.players.list();
                this.fields.find(f => f.key === 'player_id').options = players.map(p => ({ value: p.id, text: p.name }));
                openDrawer('Th√™m thanh to√°n', null, 'payments');
              });
              toolbar.append(refreshBtn, addBtn);
              const tableContainer = $('<div></div>');
              renderTable(tableContainer,
                [
                  { key: 'player_name', label: 'H·ªôi vi√™n' },
                  { key: 'amount_cents', label: 'S·ªë ti·ªÅn' },
                  { key: 'currency', label: 'Ti·ªÅn t·ªá' },
                  { key: 'source_type', label: 'Ngu·ªìn' },
                  { key: 'source_id', label: 'ID ngu·ªìn' },
                  { key: 'method', label: 'Ph∆∞∆°ng th·ª©c' },
                  { key: 'status', label: 'Tr·∫°ng th√°i' },
                  { key: 'created_at', label: 'Ng√†y t·∫°o' }
                ],
                data,
                { actions: true, onEdit: true, onDelete: true }
              );
              tableContainer.on('click', 'button[data-action]', async (e) => {
                const id = parseInt($(e.target).closest('tr').data('id'), 10);
                const row = this.data.find(r => r.id === id);
                const action = $(e.target).data('action');
                if (action === 'edit') {
                  const players = await api.players.list();
                  this.fields.find(f => f.key === 'player_id').options = players.map(p => ({ value: p.id, text: p.name }));
                  openDrawer('S·ª≠a thanh to√°n', row, 'payments');
                } else if (action === 'delete') {
                  if (confirm('Xo√° thanh to√°n?')) {
                    api.payments.remove(id).then(() => this.load());
                  }
                }
              });
              container.empty().append($('<div class="card"></div>').append(toolbar, tableContainer));
            },
            create: (d) => api.payments.create({
              player_id: parseInt(d.player_id, 10),
              amount_cents: parseInt(d.amount_cents || '0', 10),
              currency: d.currency,
              source_type: d.source_type,
              source_id: d.source_id ? parseInt(d.source_id, 10) : null,
              method: d.method,
              status: d.status
            }),
            patch: (id, d) => api.payments.patch(id, d),
            remove: (id) => api.payments.remove(id)
          },
          notifications: {
            fields: [
              { key: 'player_id', label: 'H·ªôi vi√™n', type: 'select', options: [] },
              { key: 'channel', label: 'K√™nh', type: 'select', options: [{ value: 'email', text: 'Email' }, { value: 'sms', text: 'SMS' }, { value: 'push', text: 'Push' }] },
              { key: 'subject', label: 'Ti√™u ƒë·ªÅ', type: 'text' },
              { key: 'body', label: 'N·ªôi dung', type: 'textarea' },
              { key: 'scheduled_at', label: 'Th·ªùi gian g·ª≠i', type: 'datetime-local' },
              { key: 'status', label: 'Tr·∫°ng th√°i', type: 'select', options: [{ value: 'queued', text: 'H√†ng ƒë·ª£i' }, { value: 'sent', text: 'ƒê√£ g·ª≠i' }, { value: 'failed', text: 'Th·∫•t b·∫°i' }, { value: 'cancelled', text: 'H·ªßy' }] }
            ],
            load: async function () {
              const data = await api.notifications.list();
              // Remove duplicates by id
              const dedup = [];
              data.forEach(row => {
                if (!dedup.some(item => item.id === row.id)) dedup.push(row);
              });
              this.data = dedup;
              const container = $('#section-notifications');
              const toolbar = $('<div class="toolbar"></div>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              const addBtn = $('<button class="btn primary">Th√™m</button>').on('click', async () => {
                const players = await api.players.list();
                this.fields.find(f => f.key === 'player_id').options = [{ value: '', text: '(Kh√¥ng)' }].concat(players.map(p => ({ value: p.id, text: p.name })));
                openDrawer('Th√™m nh·∫Øc nh·ªü', null, 'notifications');
              });
              toolbar.append(refreshBtn, addBtn);
              const tableContainer = $('<div></div>');
              renderTable(tableContainer,
                [
                  { key: 'player_name', label: 'H·ªôi vi√™n' },
                  { key: 'channel', label: 'K√™nh' },
                  { key: 'subject', label: 'Ti√™u ƒë·ªÅ' },
                  { key: 'scheduled_at', label: 'L·ªãch g·ª≠i' },
                  { key: 'status', label: 'Tr·∫°ng th√°i' }
                ],
                data,
                { actions: true, onEdit: true, onDelete: true }
              );
              tableContainer.on('click', 'button[data-action]', async (e) => {
                const id = parseInt($(e.target).closest('tr').data('id'), 10);
                const row = this.data.find(r => r.id === id);
                const action = $(e.target).data('action');
                if (action === 'edit') {
                  const players = await api.players.list();
                  this.fields.find(f => f.key === 'player_id').options = [{ value: '', text: '(Kh√¥ng)' }].concat(players.map(p => ({ value: p.id, text: p.name })));
                  const rcopy = { ...row };
                  if (rcopy.player_id == null) rcopy.player_id = '';
                  rcopy.scheduled_at = row.scheduled_at ? row.scheduled_at.replace(' ', 'T') : '';
                  openDrawer('S·ª≠a nh·∫Øc nh·ªü', rcopy, 'notifications');
                } else if (action === 'delete') {
                  if (confirm('Xo√° nh·∫Øc nh·ªü?')) {
                    api.notifications.remove(id).then(() => this.load());
                  }
                }
              });
              container.empty().append($('<div class="card"></div>').append(toolbar, tableContainer));
            },
            create: (d) => api.notifications.create({
              player_id: d.player_id ? parseInt(d.player_id, 10) : null,
              channel: d.channel,
              subject: d.subject,
              body: d.body,
              scheduled_at: d.scheduled_at.replace('T', ' '),
              status: d.status
            }),
            patch: (id, d) => {
              if (d.player_id === '') d.player_id = null;
              if (d.scheduled_at) d.scheduled_at = d.scheduled_at.replace('T', ' ');
              return api.notifications.patch(id, d);
            },
            remove: (id) => api.notifications.remove(id)
          },
          messages: {
            fields: [
              { key: 'player_id', label: 'H·ªôi vi√™n', type: 'select', options: [] },
              { key: 'channel', label: 'K√™nh', type: 'select', options: [{ value: 'email', text: 'Email' }, { value: 'sms', text: 'SMS' }, { value: 'push', text: 'Push' }] },
              { key: 'subject', label: 'Ti√™u ƒë·ªÅ', type: 'text' },
              { key: 'body', label: 'N·ªôi dung', type: 'textarea' },
              { key: 'tags', label: 'Tags (ph√¢n t√°ch d·∫•u ph·∫©y)', type: 'text' },
              { key: 'status', label: 'Tr·∫°ng th√°i', type: 'select', options: [{ value: 'sent', text: 'ƒê√£ g·ª≠i' }, { value: 'failed', text: 'Th·∫•t b·∫°i' }] }
            ],
            load: async function () {
              const data = await api.messages.list();
              // Remove duplicates by id
              const dedup = [];
              data.forEach(row => {
                if (!dedup.some(item => item.id === row.id)) dedup.push(row);
              });
              this.data = dedup;
              const container = $('#section-messages');
              const toolbar = $('<div class="toolbar"></div>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              const addBtn = $('<button class="btn primary">Th√™m</button>').on('click', async () => {
                const players = await api.players.list();
                this.fields.find(f => f.key === 'player_id').options = [{ value: '', text: '(Kh√¥ng)' }].concat(players.map(p => ({ value: p.id, text: p.name })));
                openDrawer('G·ª≠i tin nh·∫Øn', null, 'messages');
              });
              toolbar.append(refreshBtn, addBtn);
              const tableContainer = $('<div></div>');
              renderTable(tableContainer,
                [
                  { key: 'player_name', label: 'H·ªôi vi√™n' },
                  { key: 'channel', label: 'K√™nh' },
                  { key: 'subject', label: 'Ti√™u ƒë·ªÅ' },
                  { key: 'sent_at', label: 'Th·ªùi gian' },
                  { key: 'status', label: 'Tr·∫°ng th√°i' }
                ],
                data,
                { actions: false }
              );
              container.empty().append($('<div class="card"></div>').append(toolbar, tableContainer));
            },
            create: (d) => api.messages.create({
              player_id: d.player_id ? parseInt(d.player_id, 10) : null,
              channel: d.channel,
              subject: d.subject,
              body: d.body,
              tags: d.tags ? d.tags.split(',').map(x => x.trim()) : null,
              status: d.status
            }),
            patch: null,
            remove: null
          },
          payments: {
            data: [],
            load: async function () {
              const container = $('#section-payments');
              container.empty();

              // Check if there's a pending payment for a reservation
              if (window.pendingPaymentReservation) {
                // Show payment form
                this.renderPaymentForm(container);
              } else {
                // Show payment history
                await this.renderPaymentHistory(container);
              }
            },
            renderPaymentForm: async function (container) {
              const reservation = window.pendingPaymentReservation;
              const self = this; // Store reference to module

              // Check if this reservation already has a payment
              let existingPayment = null;
              try {
                const allPayments = await api.payments.list();
                existingPayment = allPayments.find(p =>
                  p.source_type === 'reservation' && p.source_id === reservation.id
                );
              } catch (err) {
                console.error('Error checking existing payment:', err);
              }

              const formCard = $('<div class="card"></div>');
              const isUpdate = !!existingPayment;
              formCard.append(`<h3>${isUpdate ? 'C·∫≠p nh·∫≠t thanh to√°n' : 'Thanh to√°n ƒë∆°n ƒë·∫∑t s√¢n'}</h3>`);

              // Reservation info (read-only)
              const infoSection = $('<div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;"></div>');
              infoSection.append(`
              <div style="margin-bottom: 0.5rem;"><strong>S√¢n:</strong> ${reservation.court_name}</div>
              <div style="margin-bottom: 0.5rem;"><strong>Ng∆∞·ªùi ƒë·∫∑t:</strong> ${reservation.player_name}</div>
              <div style="margin-bottom: 0.5rem;"><strong>Th·ªùi gian:</strong> ${reservation.start_time} ‚Üí ${reservation.end_time}</div>
              <div style="margin-bottom: 0.5rem;"><strong>S·ªë ti·ªÅn:</strong> <span style="color: var(--brand); font-size: 1.2em; font-weight: bold;">${formatCurrency(reservation.price_cents)}</span></div>
            `);

              if (isUpdate) {
                infoSection.append(`
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                  <div style="color: var(--muted); font-size: 0.9em;">Thanh to√°n hi·ªán t·∫°i:</div>
                  <div style="margin-top: 0.5rem;"><strong>Ph∆∞∆°ng th·ª©c:</strong> ${existingPayment.method}</div>
                  <div><strong>Ng√†y t·∫°o:</strong> ${new Date(existingPayment.created_at).toLocaleString('vi-VN')}</div>
                </div>
              `);
              }

              formCard.append(infoSection);

              // Payment method selection
              const methodGroup = $('<div class="form-group"></div>');
              methodGroup.append('<label>H√¨nh th·ª©c thanh to√°n:</label>');
              const methodSelect = $(`
              <select id="payment-method" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px;">
                <option value="cash">Ti·ªÅn m·∫∑t</option>
                <option value="card">Th·∫ª</option>
                <option value="bank">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                <option value="wallet">V√≠ ƒëi·ªán t·ª≠</option>
              </select>
            `);

              // Set current method if updating
              if (isUpdate) {
                methodSelect.val(existingPayment.method);
              }

              methodGroup.append(methodSelect);
              formCard.append(methodGroup);

              // Action buttons
              const btnGroup = $('<div style="margin-top: 1.5rem; display: flex; gap: 1rem;"></div>');
              const confirmBtn = $(`<button class="btn primary">${isUpdate ? 'C·∫≠p nh·∫≠t thanh to√°n' : 'X√°c nh·∫≠n thanh to√°n'}</button>`);
              const cancelBtn = $('<button class="btn">H·ªßy</button>');

              confirmBtn.on('click', async () => {
                const method = $('#payment-method').val();
                try {
                  if (isUpdate) {
                    // Update existing payment
                    await api.payments.patch(existingPayment.id, {
                      method: method,
                      amount_cents: reservation.price_cents
                    });
                    showToast('C·∫≠p nh·∫≠t thanh to√°n th√†nh c√¥ng!', 'success');
                  } else {
                    // Create new payment
                    await api.payments.create({
                      player_id: reservation.player_id,
                      amount_cents: reservation.price_cents,
                      currency: 'VND',
                      source_type: 'reservation',
                      source_id: reservation.id,
                      method: method,
                      status: 'succeeded'
                    });
                    showToast('Thanh to√°n th√†nh c√¥ng!', 'success');
                  }

                  window.pendingPaymentReservation = null;

                  // Reload payment history and reservations
                  await self.load();
                  await modules.reservations.load();
                } catch (err) {
                  showToast('L·ªói thanh to√°n: ' + (err.responseJSON?.error || err.statusText), 'error');
                }
              });

              cancelBtn.on('click', () => {
                window.pendingPaymentReservation = null;
                self.load();
              });

              btnGroup.append(confirmBtn, cancelBtn);
              formCard.append(btnGroup);
              container.append(formCard);
            },
            renderPaymentHistory: async function (container) {
              const data = await api.payments.list();
              this.data = data;

              const card = $('<div class="card"></div>');
              card.append('<h3>L·ªãch s·ª≠ thanh to√°n</h3>');

              const toolbar = $('<div class="toolbar"></div>');
              const refreshBtn = $('<button class="btn">T·∫£i l·∫°i</button>').on('click', () => this.load());
              toolbar.append(refreshBtn);

              const tableContainer = $('<div></div>');
              renderTable(tableContainer,
                [
                  { key: 'id', label: 'ID' },
                  { key: 'player_name', label: 'Ng∆∞·ªùi ch∆°i' },
                  { key: 'amount_cents', label: 'S·ªë ti·ªÅn', render: (v) => formatCurrency(v) },
                  { key: 'source_type', label: 'Ngu·ªìn' },
                  { key: 'method', label: 'Ph∆∞∆°ng th·ª©c' },
                  { key: 'created_at', label: 'Ng√†y t·∫°o', render: (v) => new Date(v).toLocaleString('vi-VN') }
                ],
                data,
                { actions: false }
              );

              card.append(toolbar, tableContainer);
              container.append(card);
            }
          }
        };

        // Load schedule view in right panel
        async function loadSchedule() {
          const sched = await api.reports.schedule();
          const container = $('#schedule-container');
          container.empty();
          // Group by date then by court
          const reservations = sched.reservations;
          const waitlist = sched.waitlist;
          const grouped = {};
          reservations.forEach(r => {
            const d = r.start_time.slice(0, 10);
            if (!grouped[d]) grouped[d] = { reservations: [], waitlist: [] };
            grouped[d].reservations.push(r);
          });
          waitlist.forEach(w => {
            const d = w.start_time.slice(0, 10);
            if (!grouped[d]) grouped[d] = { reservations: [], waitlist: [] };
            grouped[d].waitlist.push(w);
          });
          for (const date in grouped) {
            const group = grouped[date];
            const card = $('<div class="card"></div>');
            card.append(`<h3>${date}</h3>`);
            const resTbl = $('<div></div>');
            renderTable(resTbl, [{ key: 'court_name', label: 'S√¢n' }, { key: 'player_name', label: 'Ng∆∞·ªùi ƒë·∫∑t' }, { key: 'start_time', label: 'B·∫Øt ƒë·∫ßu' }, { key: 'end_time', label: 'K·∫øt th√∫c' }, { key: 'status', label: 'Tr·∫°ng th√°i' }], group.reservations);
            card.append('<strong>ƒê·∫∑t s√¢n</strong>');
            card.append(resTbl);
            const waitTbl = $('<div></div>');
            renderTable(waitTbl, [{ key: 'court_name', label: 'S√¢n' }, { key: 'player_name', label: 'Ng∆∞·ªùi ƒë·ª£i' }, { key: 'start_time', label: 'B·∫Øt ƒë·∫ßu' }, { key: 'end_time', label: 'K·∫øt th√∫c' }, { key: 'status', label: 'Tr·∫°ng th√°i' }], group.waitlist);
            card.append('<strong>Danh s√°ch ch·ªù</strong>');
            card.append(waitTbl);
            container.append(card);
          }
        }

        // Navigation
        $('nav button').on('click', function () {
          $('nav button').removeClass('active');
          $(this).addClass('active');
          const section = $(this).data('section');
          $('.section').hide();
          $('#section-' + section).show();

          // Hide/Show right panel based on section
          if (section === 'reservations') {
            $('#right-panel').show();
            $('#schedule-view').show();
            loadSchedule();
          } else {
            $('#right-panel').hide();
          }

          // Load data for section
          if (section === 'players') modules.players.load();
          else if (section === 'courts') modules.courts.load();
          else if (section === 'reservations') modules.reservations.load();
          else if (section === 'waitlist') modules.waitlist.load();
          else if (section === 'events') modules.events.load();
          else if (section === 'memberships') modules.memberships.load();
          else if (section === 'payments') modules.payments.load();
          else if (section === 'notifications') modules.notifications.load();
          else if (section === 'messages') modules.messages.load();
        });
        // default load players
        modules.players.load();

        // Resizable handle
        (() => {
          const split = $('.container');
          const handle = $('#drag-handle');
          let dragging = false;
          handle.on('mousedown touchstart', (e) => { dragging = true; $('body').css('user-select', 'none'); });
          $(window).on('mousemove touchmove', (e) => {
            if (!dragging) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const total = window.innerWidth;
            const minLeft = 300;
            const minRight = 280;
            const leftW = Math.min(Math.max(clientX, minLeft), total - minRight);
            const rightW = total - leftW - 8;
            split.css('grid-template-columns', `${leftW}px 8px ${rightW}px`);
          });
          $(window).on('mouseup touchend', () => { dragging = false; $('body').css('user-select', ''); });
        })();
      })();
  </script>
</body>

</html>